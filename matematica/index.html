import React, { useState, useEffect, useRef } from 'react';
import { Ruler, Calculator, Play, RefreshCw, ChevronRight, Info, Triangle } from 'lucide-react';

const MathApp = () => {
  const [activeTab, setActiveTab] = useState('pythagoras');
  
  // 畢氏定律狀態 (Pythagoras State)
  const [sideA, setSideA] = useState(3); // 高 (Altitude)
  const [sideB, setSideB] = useState(4); // 底 (Base)
  
  // 三角函數狀態 (Trig State)
  const [angle, setAngle] = useState(30); // 角度 (Theta)
  const [hypotenuse, setHypotenuse] = useState(10); // 斜邊長度

  // 顏色系統 (Color System) - 用於統一視覺
  const colors = {
    a: "text-rose-500",      // 對邊/高
    bgA: "bg-rose-500",
    borderA: "border-rose-500",
    fillA: "fill-rose-500",
    b: "text-sky-500",       // 鄰邊/底
    bgB: "bg-sky-500",
    borderB: "border-sky-500",
    c: "text-emerald-500",   // 斜邊
    bgC: "bg-emerald-500",
    borderC: "border-emerald-500",
    theta: "text-amber-500", // 角度
    strokeTheta: "stroke-amber-500"
  };

  // --- 畢氏定律計算 ---
  const pythagorasC = Math.sqrt(sideA * sideA + sideB * sideB);
  
  // --- 三角函數計算 ---
  const rad = angle * (Math.PI / 180);
  const trigOpposite = Math.sin(rad) * hypotenuse; // 對邊
  const trigAdjacent = Math.cos(rad) * hypotenuse; // 鄰邊

  // 格式化數字
  const fmt = (num) => Number(num).toFixed(2);

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-10">
      {/* 標題列 */}
      <header className="bg-white shadow-sm sticky top-0 z-10">
        <div className="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="p-2 bg-indigo-600 rounded-lg text-white">
              <Triangle size={24} />
            </div>
            <div>
              <h1 className="text-xl font-bold text-slate-900">數學視覺化實驗室</h1>
              <p className="text-xs text-slate-500">專為高中生設計的基礎補強工具</p>
            </div>
          </div>
          <div className="flex bg-slate-100 p-1 rounded-lg">
            <button
              onClick={() => setActiveTab('pythagoras')}
              className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                activeTab === 'pythagoras' 
                  ? 'bg-white text-indigo-600 shadow-sm' 
                  : 'text-slate-500 hover:text-slate-700'
              }`}
            >
              畢氏定律
            </button>
            <button
              onClick={() => setActiveTab('trig')}
              className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                activeTab === 'trig' 
                  ? 'bg-white text-indigo-600 shadow-sm' 
                  : 'text-slate-500 hover:text-slate-700'
              }`}
            >
              基礎三角函數
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-4xl mx-auto px-4 py-8">
        {activeTab === 'pythagoras' ? (
          <PythagorasModule 
            sideA={sideA} setSideA={setSideA}
            sideB={sideB} setSideB={setSideB}
            sideC={pythagorasC}
            colors={colors}
            fmt={fmt}
          />
        ) : (
          <TrigonometryModule 
            angle={angle} setAngle={setAngle}
            hypotenuse={hypotenuse} setHypotenuse={setHypotenuse}
            opposite={trigOpposite}
            adjacent={trigAdjacent}
            colors={colors}
            fmt={fmt}
          />
        )}
      </main>
    </div>
  );
};

// --- 畢氏定律模組 ---
const PythagorasModule = ({ sideA, setSideA, sideB, setSideB, sideC, colors, fmt }) => {
  // SVG Viewbox settings
  const scale = 25; 
  const padding = 40;
  // 限制畫布大小
  const maxVal = 15; 
  const viewBoxSize = maxVal * scale + padding * 2;
  
  // 座標計算 (原點在左下角)
  // A: 頂點 (0, a), B: 右下角 (b, 0), C: 直角點 (0, 0) -> 這種畫法較符合數學象限，但為了符合一般三角形習慣，我們將直角放在右下
  
  // 為了視覺效果，我們固定直角在右下角
  // P1 (Top): (sideB, sideA) 
  // P2 (Bottom Left): (0, 0) -> 銳角
  // P3 (Bottom Right): (sideB, 0) -> 直角
  
  // 修正座標，讓圖形置中
  const startX = padding;
  const startY = viewBoxSize - padding; // SVG y軸向下，所以底端是大數值

  const p3_x = startX + sideB * scale;
  const p3_y = startY;
  
  const p2_x = startX;
  const p2_y = startY;

  const p1_x = p2_x + sideB * scale; // 直角在右下
  const p1_y = startY - sideA * scale;

  // 這裡我們畫：直角在「右下角」的圖形，這樣 a 是高，b 是底
  // A point (top): x = startX + b*scale, y = startY - a*scale
  // B point (left): x = startX, y = startY
  // C point (right angle): x = startX + b*scale, y = startY

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
      {/* 左側：控制與教學 */}
      <div className="space-y-6">
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span className="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-sm">1</span>
            直角三角形的秘密
          </h2>
          <p className="text-slate-600 mb-6 leading-relaxed">
            畢氏定律說明了直角三角形三邊的關係：
            <br/>
            <span className={`font-bold ${colors.a}`}>股 (a)</span> 的平方 加上 <span className={`font-bold ${colors.b}`}>股 (b)</span> 的平方，
            等於 <span className={`font-bold ${colors.c}`}>斜邊 (c)</span> 的平方。
          </p>

          <div className="p-4 bg-slate-50 rounded-xl border border-slate-200 mb-6">
            <div className="text-center text-xl font-mono font-bold text-slate-700">
              <span className={colors.a}>a²</span> + <span className={colors.b}>b²</span> = <span className={colors.c}>c²</span>
            </div>
          </div>

          {/* 控制滑桿 */}
          <div className="space-y-6">
            <div>
              <div className="flex justify-between mb-2">
                <label className={`font-bold ${colors.a} flex items-center gap-2`}>
                  <Ruler size={16}/> 垂直邊 (a): {sideA}
                </label>
              </div>
              <input
                type="range" min="1" max="12" step="1"
                value={sideA} onChange={(e) => setSideA(Number(e.target.value))}
                className="w-full h-2 bg-rose-100 rounded-lg appearance-none cursor-pointer accent-rose-500"
              />
            </div>

            <div>
              <div className="flex justify-between mb-2">
                <label className={`font-bold ${colors.b} flex items-center gap-2`}>
                  <Ruler size={16}/> 水平邊 (b): {sideB}
                </label>
              </div>
              <input
                type="range" min="1" max="12" step="1"
                value={sideB} onChange={(e) => setSideB(Number(e.target.value))}
                className="w-full h-2 bg-sky-100 rounded-lg appearance-none cursor-pointer accent-sky-500"
              />
            </div>
          </div>
        </div>

        {/* 計算過程 */}
        <div className="bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
          <h3 className="font-bold text-indigo-900 mb-3 flex items-center gap-2">
            <Calculator size={18}/> 即時計算
          </h3>
          <div className="space-y-2 font-mono text-lg">
            <div className="flex items-center gap-2">
              <span className={`${colors.a} font-bold`}>{sideA}²</span> + 
              <span className={`${colors.b} font-bold`}>{sideB}²</span> = 
              <span>{sideA*sideA} + {sideB*sideB}</span> = 
              <span className="font-bold">{sideA*sideA + sideB*sideB}</span>
            </div>
            <div className="flex items-center gap-2 pt-2 border-t border-indigo-200">
              <span className="text-slate-600">c = </span>
              <span>√{sideA*sideA + sideB*sideB}</span> = 
              <span className={`${colors.c} text-2xl font-bold`}>{fmt(sideC)}</span>
            </div>
          </div>
        </div>
      </div>

      {/* 右側：視覺化圖形 */}
      <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-center min-h-[400px] relative overflow-hidden">
        <div className="absolute top-4 right-4 text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded border">
          圖形依照比例繪製
        </div>
        
        <svg width="100%" height="400" viewBox={`0 0 ${viewBoxSize} ${viewBoxSize}`} className="max-w-full max-h-full drop-shadow-xl">
          <defs>
            <pattern id="grid" width="25" height="25" patternUnits="userSpaceOnUse">
              <path d="M 25 0 L 0 0 0 25" fill="none" stroke="#f1f5f9" strokeWidth="1"/>
            </pattern>
          </defs>
          <rect width="100%" height="100%" fill="url(#grid)" />

          {/* 繪製三角形 */}
          {/* 直角標記 */}
          <path 
            d={`M ${p1_x - 20} ${p3_y} L ${p1_x - 20} ${p3_y - 20} L ${p1_x} ${p3_y - 20}`}
            fill="none" stroke="#94a3b8" strokeWidth="2"
          />

          {/* 三角形本體 */}
          <path 
            d={`M ${p2_x} ${p2_y} L ${p1_x} ${p3_y} L ${p1_x} ${p1_y} Z`}
            fill="rgba(255, 255, 255, 0.8)" stroke="none"
          />
          
          {/* 邊 b (底) */}
          <line x1={p2_x} y1={p2_y} x2={p1_x} y2={p3_y} stroke="#0ea5e9" strokeWidth="4" strokeLinecap="round" />
          <text x={(p2_x + p1_x)/2} y={p3_y + 25} fill="#0ea5e9" fontSize="20" fontWeight="bold" textAnchor="middle">b = {sideB}</text>

          {/* 邊 a (高) */}
          <line x1={p1_x} y1={p3_y} x2={p1_x} y2={p1_y} stroke="#f43f5e" strokeWidth="4" strokeLinecap="round" />
          <text x={p1_x + 15} y={(p3_y + p1_y)/2} fill="#f43f5e" fontSize="20" fontWeight="bold" dominantBaseline="middle">a = {sideA}</text>

          {/* 邊 c (斜邊) */}
          <line x1={p2_x} y1={p2_y} x2={p1_x} y2={p1_y} stroke="#10b981" strokeWidth="4" strokeLinecap="round" />
          <text x={(p2_x + p1_x)/2 - 15} y={(p2_y + p1_y)/2 - 15} fill="#10b981" fontSize="20" fontWeight="bold" textAnchor="end">c = {fmt(sideC)}</text>
          
          {/* 頂點標記 */}
          <circle cx={p2_x} cy={p2_y} r="4" fill="#64748b" />
          <circle cx={p1_x} cy={p3_y} r="4" fill="#64748b" />
          <circle cx={p1_x} cy={p1_y} r="4" fill="#64748b" />

        </svg>
      </div>
    </div>
  );
};

// --- 三角函數模組 ---
const TrigonometryModule = ({ angle, setAngle, hypotenuse, setHypotenuse, opposite, adjacent, colors, fmt }) => {
  // SVG Setup
  const scale = 25;
  const padding = 60;
  const viewBoxSize = 500;
  
  // 讓三角形固定左下角，向右上方長出
  const startX = padding;
  const startY = viewBoxSize - padding;

  // 計算頂點位置
  // C (直角): 在 (startX + adjacent, startY)
  // B (角度原點): 在 (startX, startY)
  // A (頂點): 在 (startX + adjacent, startY - opposite)
  
  // 在此模式中，我們根據斜邊長度與角度來計算座標，保持斜邊長度真實反映
  // 但為了避免超出邊界，如果斜邊太長可以只改變數字不改變圖形大小？
  // 不，為了高視覺化，我們讓圖形真的動起來。我們會限制最大斜邊。
  
  const px_adj = adjacent * scale;
  const px_opp = opposite * scale;
  
  const p_origin_x = startX;
  const p_origin_y = startY;
  
  const p_right_x = startX + px_adj;
  const p_right_y = startY;
  
  const p_top_x = startX + px_adj;
  const p_top_y = startY - px_opp;

  // 角度弧線計算
  const arcRadius = 40;
  const largeArcFlag = 0; // 我們的角度永遠小於 90，所以是 0
  // 起點 (on adjacent side)
  const arcStart_x = p_origin_x + arcRadius;
  const arcStart_y = p_origin_y;
  // 終點 (on hypotenuse side)
  const arcEnd_x = p_origin_x + arcRadius * Math.cos(angle * Math.PI / 180);
  const arcEnd_y = p_origin_y - arcRadius * Math.sin(angle * Math.PI / 180);

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
      {/* 左側：控制與概念 */}
      <div className="space-y-6">
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span className="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-sm">2</span>
            sin, cos, tan 是什麼？
          </h2>
          <p className="text-slate-600 mb-4">
            不要死背！它們只是直角三角形中，<span className="font-bold text-slate-800">兩個邊長的比值</span>。
            <br/>決定比值的關鍵只有一個：<span className={`font-bold ${colors.theta}`}>角度 θ (Theta)</span>。
          </p>

          {/* 控制區 */}
          <div className="space-y-8 mt-6 bg-slate-50 p-4 rounded-xl border border-slate-200">
            <div>
              <div className="flex justify-between mb-2">
                <label className={`font-bold ${colors.theta} flex items-center gap-2`}>
                  <RefreshCw size={16}/> 角度 θ (Theta): {angle}°
                </label>
              </div>
              <input
                type="range" min="1" max="89" step="1"
                value={angle} onChange={(e) => setAngle(Number(e.target.value))}
                className="w-full h-2 bg-amber-100 rounded-lg appearance-none cursor-pointer accent-amber-500"
              />
              <p className="text-xs text-slate-500 mt-1">試著拉動角度，觀察對邊(紅)和鄰邊(藍)的消長！</p>
            </div>

            <div>
              <div className="flex justify-between mb-2">
                <label className={`font-bold ${colors.c} flex items-center gap-2`}>
                  <Ruler size={16}/> 斜邊長度: {hypotenuse}
                </label>
              </div>
              <input
                type="range" min="5" max="14" step="0.5"
                value={hypotenuse} onChange={(e) => setHypotenuse(Number(e.target.value))}
                className="w-full h-2 bg-emerald-100 rounded-lg appearance-none cursor-pointer accent-emerald-500"
              />
            </div>
          </div>
        </div>

        {/* 公式卡片 */}
        <div className="grid grid-cols-1 gap-3">
            <TrigCard 
                title="sin θ (正弦)" 
                formula="對邊 / 斜邊"
                val1={opposite} color1={colors.a}
                val2={hypotenuse} color2={colors.c}
                result={opposite / hypotenuse}
                desc="當角度變大，對邊變長，sin 值也會變大。"
                fmt={fmt}
            />
            <TrigCard 
                title="cos θ (餘弦)" 
                formula="鄰邊 / 斜邊"
                val1={adjacent} color1={colors.b}
                val2={hypotenuse} color2={colors.c}
                result={adjacent / hypotenuse}
                desc="當角度變大，鄰邊變短，cos 值會變小。"
                fmt={fmt}
            />
            <TrigCard 
                title="tan θ (正切)" 
                formula="對邊 / 鄰邊"
                val1={opposite} color1={colors.a}
                val2={adjacent} color2={colors.b}
                result={opposite / adjacent}
                desc="這是斜率！角度越大，坡度越陡，tan 值暴增。"
                fmt={fmt}
            />
        </div>
      </div>

      {/* 右側：動態視覺化 */}
      <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center min-h-[500px] relative overflow-hidden">
        <div className="absolute top-4 left-4 z-10">
             <div className="text-sm font-bold text-slate-600 bg-white/90 px-3 py-2 rounded shadow border">
                口訣記憶：
                <div className="text-xs font-normal text-slate-500 mt-1">
                   Sin = <span className={colors.a}>對</span> / <span className={colors.c}>斜</span> (SOH)<br/>
                   Cos = <span className={colors.b}>鄰</span> / <span className={colors.c}>斜</span> (CAH)<br/>
                   Tan = <span className={colors.a}>對</span> / <span className={colors.b}>鄰</span> (TOA)
                </div>
             </div>
        </div>

        <svg width="100%" height="450" viewBox={`0 0 ${viewBoxSize} ${viewBoxSize}`} className="max-w-full drop-shadow-xl">
          <defs>
            <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
              <path d="M0,0 L0,6 L9,3 z" fill="#64748b" />
            </marker>
          </defs>

          {/* 網格背景 */}
          <pattern id="gridTrig" width="25" height="25" patternUnits="userSpaceOnUse">
              <path d="M 25 0 L 0 0 0 25" fill="none" stroke="#f8fafc" strokeWidth="1"/>
          </pattern>
          <rect width="100%" height="100%" fill="url(#gridTrig)" />

          {/* 陰影三角形 */}
          <path 
            d={`M ${p_origin_x} ${p_origin_y} L ${p_right_x} ${p_right_y} L ${p_top_x} ${p_top_y} Z`}
            fill="rgba(241, 245, 249, 0.5)" stroke="none"
          />

          {/* 角度弧線 */}
          <path
            d={`M ${arcStart_x} ${arcStart_y} A ${arcRadius} ${arcRadius} 0 0 0 ${arcEnd_x} ${arcEnd_y}`}
            fill="rgba(251, 191, 36, 0.2)" stroke="#fbbf24" strokeWidth="2"
          />
          <text x={p_origin_x + 50} y={p_origin_y - 10} fill="#d97706" fontSize="16" fontWeight="bold">{angle}°</text>

          {/* 直角標記 */}
          <path 
            d={`M ${p_right_x - 15} ${p_right_y} L ${p_right_x - 15} ${p_right_y - 15} L ${p_right_x} ${p_right_y - 15}`}
            fill="none" stroke="#94a3b8" strokeWidth="2"
          />

          {/* 鄰邊 (Adjacent) */}
          <line x1={p_origin_x} y1={p_origin_y} x2={p_right_x} y2={p_right_y} stroke="#0ea5e9" strokeWidth="5" strokeLinecap="round" />
          {/* 鄰邊虛線投影 (如果需要) */}
          <text x={(p_origin_x + p_right_x)/2} y={p_origin_y + 25} fill="#0ea5e9" fontSize="18" fontWeight="bold" textAnchor="middle">鄰邊 (Adj) = {fmt(adjacent)}</text>

          {/* 對邊 (Opposite) */}
          <line x1={p_right_x} y1={p_right_y} x2={p_top_x} y2={p_top_y} stroke="#f43f5e" strokeWidth="5" strokeLinecap="round" />
          <text x={p_right_x + 15} y={(p_right_y + p_top_y)/2} fill="#f43f5e" fontSize="18" fontWeight="bold" dominantBaseline="middle">對邊 (Opp) = {fmt(opposite)}</text>

          {/* 斜邊 (Hypotenuse) */}
          <line x1={p_origin_x} y1={p_origin_y} x2={p_top_x} y2={p_top_y} stroke="#10b981" strokeWidth="5" strokeLinecap="round" />
          {/* 斜邊文字需要一點角度計算來放置，這裡簡化放中間上方 */}
          <text x={(p_origin_x + p_top_x)/2 - 20} y={(p_origin_y + p_top_y)/2 - 15} fill="#10b981" fontSize="18" fontWeight="bold" textAnchor="end">斜邊 (Hyp) = {hypotenuse}</text>

          {/* 頂點標記 */}
          <circle cx={p_origin_x} cy={p_origin_y} r="5" fill="#64748b" />
          <circle cx={p_top_x} cy={p_top_y} r="5" fill="#64748b" />
          <circle cx={p_right_x} cy={p_right_y} r="5" fill="#64748b" />
        </svg>

        <div className="mt-2 text-center text-slate-400 text-xs">
            * 圖形為即時渲染，精確反映當前數值
        </div>
      </div>
    </div>
  );
};

const TrigCard = ({ title, formula, val1, color1, val2, color2, result, desc, fmt }) => (
    <div className="bg-white p-4 rounded-xl border border-slate-200 hover:border-indigo-300 transition-colors shadow-sm">
        <div className="flex justify-between items-center mb-2">
            <h4 className="font-bold text-slate-800 text-lg">{title}</h4>
            <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">{formula}</span>
        </div>
        <div className="flex items-center gap-3 text-lg font-mono mb-2">
            <span className={`font-bold ${color1}`}>{fmt(val1)}</span>
            <span className="text-slate-400">/</span>
            <span className={`font-bold ${color2}`}>{fmt(val2)}</span>
            <span className="text-slate-400">=</span>
            <span className="font-bold text-indigo-600 bg-indigo-50 px-2 rounded">{fmt(result)}</span>
        </div>
        <p className="text-xs text-slate-500">{desc}</p>
    </div>
);

export default MathApp;
